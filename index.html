<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style type="text/css">
    * {
      box-sizing: border-box;
      position: relative;
    }

    body {
      height: 100vh;
      width: 100vw;
      display: flex;
      margin: 0;
    }

    .editor {
      width: 100%;
      flex-grow: 1;
    }

    .editor:before {
      content: attr(data-file);
      display: block;
      position: absolute;
      top: 0;
      right: 0;
      background: white;
      padding: 5px;
    }

    textarea {
      height: 100%;
      width: 100%;
      resize: none;
    }

    .half {
      height: 100%;
      width: 50%;
      display: flex;
      flex-direction: column;
    }

    iframe {
      height: 100%;
      width: 100%;
      border: 0;
    }
  </style>
</head>
<body>
  <div class="half">
    <div class="editor" data-file="/index.mjml">
      <textarea><mjml>
  <mj-body>
    <mj-section>
      <mj-column>

        <mj-image width="100px" src="/assets/img/logo-small.png"></mj-image>

        <mj-divider border-color="#F45E43"></mj-divider>

        <mj-text font-size="20px" color="#F45E43" font-family="helvetica">Hello World</mj-text>

      </mj-column>
    </mj-section>
  </mj-body>
</mjml></textarea>
    </div>
    <div class="editor" data-file="/style.scss">
      <textarea>body {background: lightblue;}</textarea>
    </div>
  </div>
  <div class="half">
    <iframe></iframe>
  </div>
  <script src="./packages/tape/bundle.js"></script>
  <script src="./packages/sass-plugin/bundle.js"></script>
  <script src="./packages/mjml-plugin/bundle.js"></script>
  <script>
    const mimeType = {
      '.css': 'text/css',
      '.html': 'text/html',
    }

    const urlWrite = {
      name: 'urlWrite',
      write({ asset, cache }) {
        if (asset.isEntry) {
          return `${asset.path.replace(
            new RegExp(`${asset.originalExt}$`),
            asset.ext
          )}`;
        }

        const objectURL = URL.createObjectURL(new Blob([asset.content], {
          type: mimeType[asset.ext]
        }))

        cache.set(asset.id, objectURL)
        return objectURL
      },
      onChange({ asset, cache }) {
        const objectURL = cache.get(asset.id) 
        
        if (objectURL) {
          cache.delete(asset.id)
          URL.revokeObjectURL(objectURL)
        }
      }
    }

    const iframe = document.querySelector('iframe')
    const baseFiles = {};
    [...document.querySelectorAll('.editor')].forEach(editor => {
      baseFiles[editor.getAttribute('data-file')] = {
        content: editor.querySelector('textarea').value
      }
    })
    const tape = new Tape({
      entry: "/index.html",
      plugins: [
        tapeSassPlugin,
        urlWrite
      ],
      files: baseFiles,
    });


    const manager = tape.dev();
    manager.on('*', (event, data) => {
      if (event === 'ready' || event === 'end') {
        iframe.contentWindow.document.open();
        iframe.contentWindow.document.write(data.files[data.entry].content);
        iframe.contentWindow.document.close();
      }

      if (event === 'error') {
        console.log(data.error)
        iframe.contentWindow.document.open();
        iframe.contentWindow.document.write(`
          <html>
          <body style="margin: 0; font-family: system-ui; color: #730f45;box-sizing: border-box;background: #fce4ec; padding: 20px; height: 100vh;width: 100vw; display: flex; justify-content: space-between; align-items: center;">
            <div><h1 style=" font-size: 20px;">Error: ${data.error.message}</h1>
            <pre style="width: 100%; white-space: break-spaces;">${data.error.stack}</pre></div>

          </body>
          </html>
        `);
        iframe.contentWindow.document.close();
      }
    });

    [...document.querySelectorAll('textarea')].forEach((textarea) => {
      textarea.addEventListener('input', () => {
        const file = textarea.parentElement.getAttribute('data-file')
        tape.update({
          files: {
            [file]: {
              content: textarea.value
            }
          }
        })
      })
    })
    

    // (async function () {
    //   block: {


    //     // console.log((await tape.build()).entry)
    //     setTimeout(async () => {
    //       tape.update({
    //         files: {
    //           "/emails/index.html": {
    //             content: `<!DOCTYPE html>
    //        <html lang="en">
    //        <head>
    //          <meta charset="UTF-8">
    //          <meta name="viewport" content="width=device-width, initial-scale=1.0">
    //          <title>Document</title>
    //          <link rel="stylesheet" href="https://example.com/reset.css">
    //          <style>
    //           @import '/main.css';
    //           @import '/another.css';
    //           body {
    //             padding: 0;
    //           }
    //          </style>
    //        </head>
    //        <body>
             
    //        </body>
    //        </html>`,
    //           },
    //         },
    //       });

    //       // manager.close()

    //       //   console.log((await tape.build()).entry)
    //     }, 200);
    //   }
    // })();
  </script>
</body>
</html>